"use client";

import { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { createCamp, getAllCamps, activateCamp, setupCampCourts, archiveCamp, unarchiveCamp, deleteCamp, deleteCompleteCampData } from "@/lib/firestore-helpers";
import { auth } from "@/lib/firebase";
import { useCamp } from "@/context/CampContext";
import type { Camp } from "@/types";
import { Plus, Play, Settings, CheckCircle, Calendar, ArrowRight, Archive, ArchiveRestore, Trash2, AlertTriangle } from "lucide-react";

export default function CampManager() {
    const { refreshCamp, setManualCamp } = useCamp();

    const [camps, setCamps] = useState<Camp[]>([]);
    const [newTitle, setNewTitle] = useState("");
    const [courtCount, setCourtCount] = useState(6);
    const [loading, setLoading] = useState(false);
    const [deleting, setDeleting] = useState<string | null>(null);
    const [currentUserId, setCurrentUserId] = useState<string | null>(null);

    // 認証ユーザーを取得
    useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged((user) => {
            if (user) {
                setCurrentUserId(user.uid);
                console.log('[CampManager] 認証ユーザー:', user.uid);
            }
        });
        return () => unsubscribe();
    }, []);

    // 一覧をリアルタイム購読
    useEffect(() => {
        const loadCamps = async () => {
            try {
                const data = await getAllCamps(currentUserId || undefined);
                
                // データ蒸発防止: 空データでの上書きを防ぐ
                if (data.length === 0 && camps.length > 0) {
                    console.log('[CampManager] 空データを検知、既存データを保持');
                    return; // 既存のcampsを維持
                }
                
                // データがある場合、または初回読み込みの場合は更新
                setCamps(data);
                console.log('[CampManager] 合宿リスト更新:', data.length, '件');
            } catch (error) {
                console.error('[CampManager] 合宿リスト取得エラー:', error);
                // エラー時は既存データを維持（上書きしない）
            }
        };

        // 初回読み込み
        loadCamps();

        // 5秒ごとに再読み込み（リアルタイム更新）
        const interval = setInterval(() => {
            loadCamps();
        }, 5000);

        return () => clearInterval(interval);
    }, [currentUserId, camps.length]);

    // 新規作成
    const handleCreate = async () => {
        if (!newTitle.trim()) return;
        setLoading(true);

        // 合宿データ作成（owner_idを渡す）
        const newId = await createCamp(newTitle, courtCount, currentUserId || undefined);

        if (newId) {
            setNewTitle("");
            // リストは自動更新されるため、手動更新は不要
        }
        setLoading(false);
    };

    // 「この合宿を開催する」ボタン (Activeにする)
    const handleActivate = async (campId: string, courts: number) => {
        if (!confirm("この合宿を「開催中」にしますか？\n参加者の画面がこの合宿に切り替わります。")) return;

        setLoading(true);
        // 1. 合宿をActiveに
        await activateCamp(campId);
        // 2. コート数をセットアップ（物理コートの上書き）
        await setupCampCourts(courts);
        // 3. アプリ全体のContextを更新
        await refreshCamp();

        setLoading(false);
        // リロードして反映させる
        window.location.reload();
    };

    // 「管理画面へ」ボタン (Activeにせず、中身だけ見る)
    const handleEnter = (camp: Camp) => {
        setManualCamp(camp);
    };

    // アーカイブ
    const handleArchive = async (campId: string) => {
        if (!confirm("この合宿をアーカイブしますか？\nアーカイブ後は閲覧専用になります。")) return;
        setLoading(true);
        await archiveCamp(campId);
        setLoading(false);
    };

    // アーカイブ解除
    const handleUnarchive = async (campId: string) => {
        if (!confirm("この合宿のアーカイブを解除しますか？")) return;
        setLoading(true);
        await unarchiveCamp(campId);
        setLoading(false);
    };

    // 通常削除（Camp本体のみ）
    const handleDelete = async (campId: string) => {
        if (!confirm("この合宿を削除しますか？\nこの操作は取り消せません。")) return;
        setLoading(true);
        await deleteCamp(campId);
        setLoading(false);
    };

    // 完全削除（全関連データ含む）
    const handleCompleteDelete = async (campId: string, campTitle: string) => {
        if (!confirm(`⚠️ 警告: 完全削除を実行します\n\n合宿「${campTitle}」に紐づく以下のデータをすべて削除します：\n• 選手データ\n• 試合データ\n• コートデータ\n• トーナメント設定\n• 合宿本体\n\nこの操作は取り消せません。本当に実行しますか？`)) return;

        if (!confirm("最終確認: すべてのデータが完全に削除されます。\n本当によろしいですか？")) return;

        setDeleting(campId);
        try {
            const result = await deleteCompleteCampData(campId);

            if (result.success) {
                alert(`✓ 削除完了\n\n削除件数：\n• 選手: ${result.deletedCounts.players}件\n• 試合: ${result.deletedCounts.matches}件\n• コート: ${result.deletedCounts.courts}件\n• トーナメント設定: ${result.deletedCounts.tournamentConfigs}件`);
            } else {
                alert(`⚠️ 削除中にエラーが発生しました\n\n${result.errors.join('\n')}`);
            }

            await refreshCamp();
            window.location.reload();
        } catch (error) {
            alert(`✗ 予期せぬエラーが発生しました: ${error instanceof Error ? error.message : String(error)}`);
        }
        setDeleting(null);
    };

    return (
        <div className="container mx-auto px-4 py-8 max-w-4xl space-y-8">

            {/* ヘッダー */}
            <div className="text-center space-y-2">
                <h1 className="text-3xl font-bold text-slate-800">合宿管理メニュー</h1>
                <p className="text-slate-500">
                    新しい合宿を作成するか、管理する合宿を選択してください
                </p>
            </div>

            {/* 新規作成フォーム */}
            <Card className="bg-white border-slate-200 shadow-sm border-t-4 border-t-sky-400">
                <CardHeader>
                    <CardTitle className="flex items-center gap-2 text-slate-800">
                        <Plus className="w-5 h-5 text-sky-500" /> 新しい合宿を作成
                    </CardTitle>
                    <CardDescription>
                        合宿名と使用コート数を設定して箱を作ります
                    </CardDescription>
                </CardHeader>
                <CardContent>
                    <div className="flex flex-col md:flex-row gap-4 items-end">
                        <div className="w-full md:flex-1 space-y-2">
                            <label className="text-sm font-medium text-slate-700">合宿名 (例: 2025夏合宿)</label>
                            <Input
                                value={newTitle}
                                onChange={(e) => setNewTitle(e.target.value)}
                                placeholder="名称を入力..."
                            />
                        </div>
                        <div className="w-full md:w-32 space-y-2">
                            <label className="text-sm font-medium text-slate-700">コート数</label>
                            <Input
                                type="number"
                                value={courtCount}
                                onChange={(e) => setCourtCount(Number(e.target.value))}
                                min={1}
                                max={20}
                            />
                        </div>
                        <Button
                            onClick={handleCreate}
                            disabled={loading || !newTitle}
                            className="bg-sky-500 hover:bg-sky-600 text-white w-full md:w-auto"
                        >
                            作成する
                        </Button>
                    </div>
                </CardContent>
            </Card>

            {/* 合宿リスト */}
            <div className="space-y-4">
                <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <Calendar className="w-5 h-5" /> 作成済みの合宿リスト
                </h2>

                <div className="grid gap-4">
                    {camps.length === 0 ? (
                        <Card className="border-slate-200">
                            <CardContent className="p-8 text-center space-y-3">
                                <Calendar className="w-12 h-12 mx-auto text-slate-300" />
                                <p className="text-slate-600 font-medium">合宿がまだ作成されていません</p>
                                <p className="text-sm text-slate-500">上のフォームから新規作成してください</p>
                            </CardContent>
                        </Card>
                    ) : (
                        camps.map((camp) => (
                        <Card key={camp.id} className={`transition-all hover:shadow-md ${camp.status === 'active' ? 'border-emerald-400 ring-1 ring-emerald-100' : 'border-slate-200'}`}>
                            <CardContent className="p-6 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">

                                {/* 情報部分 */}
                                <div className="space-y-1">
                                    <div className="flex items-center gap-2">
                                        <h3 className="text-lg font-bold text-slate-900">{camp.title}</h3>
                                        {camp.status === 'active' ? (
                                            <Badge className="bg-emerald-500 hover:bg-emerald-600">開催中</Badge>
                                        ) : camp.status === 'archived' ? (
                                            <Badge variant="outline" className="text-amber-600 border-amber-300">アーカイブ済み</Badge>
                                        ) : (
                                            <Badge variant="outline" className="text-slate-500">準備中</Badge>
                                        )}
                                    </div>
                                    <p className="text-sm text-slate-500">
                                        コート数: {camp.court_count}面 | ID: {camp.id.slice(0, 8)}...
                                    </p>
                                </div>

                                {/* ボタン部分 */}
                                <div className="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                                    <div className="flex gap-2">
                                        {/* Activeにするボタン */}
                                        {camp.status === 'setup' && (
                                            <Button
                                                variant="outline"
                                                onClick={() => handleActivate(camp.id, camp.court_count)}
                                                disabled={loading || deleting === camp.id}
                                                className="flex-1 md:flex-none border-emerald-200 text-emerald-700 hover:bg-emerald-50"
                                            >
                                                <Play className="w-4 h-4 mr-1" />
                                                これを開催する
                                            </Button>
                                        )}

                                        {/* アーカイブボタン */}
                                        {camp.status === 'archived' ? (
                                            <Button
                                                variant="outline"
                                                onClick={() => handleUnarchive(camp.id)}
                                                disabled={loading || deleting === camp.id}
                                                className="flex-1 md:flex-none border-amber-200 text-amber-700 hover:bg-amber-50"
                                            >
                                                <ArchiveRestore className="w-4 h-4 mr-1" />
                                                解除
                                            </Button>
                                        ) : (
                                            <Button
                                                variant="outline"
                                                onClick={() => handleArchive(camp.id)}
                                                disabled={loading || deleting === camp.id}
                                                className="flex-1 md:flex-none border-slate-300 text-slate-600 hover:bg-slate-50"
                                            >
                                                <Archive className="w-4 h-4 mr-1" />
                                                {camp.status === 'active' ? '合宿を終了' : 'アーカイブ'}
                                            </Button>
                                        )}

                                        {/* 管理画面に入るボタン */}
                                        <Button
                                            onClick={() => handleEnter(camp)}
                                            disabled={deleting === camp.id}
                                            className="flex-1 md:flex-none bg-slate-800 text-white hover:bg-slate-700"
                                        >
                                            {camp.status === 'archived' ? '閲覧する' : '管理画面へ'}
                                            <ArrowRight className="w-4 h-4 ml-1" />
                                        </Button>
                                    </div>

                                    {/* 削除ボタン（アクティブでない場合のみ） */}
                                    {camp.status !== 'active' && (
                                        <div className="flex gap-2">
                                            <Button
                                                variant="outline"
                                                onClick={() => handleDelete(camp.id)}
                                                disabled={loading || deleting === camp.id}
                                                className="flex-1 border-rose-200 text-rose-600 hover:bg-rose-50"
                                            >
                                                <Trash2 className="w-4 h-4 mr-1" />
                                                削除
                                            </Button>
                                            <Button
                                                variant="destructive"
                                                onClick={() => handleCompleteDelete(camp.id, camp.title)}
                                                disabled={loading || deleting === camp.id}
                                                className="flex-1 bg-red-600 hover:bg-red-700"
                                            >
                                                {deleting === camp.id ? (
                                                    "削除中..."
                                                ) : (
                                                    <>
                                                        <AlertTriangle className="w-4 h-4 mr-1" />
                                                        完全削除
                                                    </>
                                                )}
                                            </Button>
                                        </div>
                                    )}
                                </div>

                            </CardContent>
                        </Card>
                        ))
                    )}
                </div>
            </div>
        </div>
    );
}